{% extends "base.html" %}
{% load can_manage %}

{% block content %}
{# Resolve HTMX endpoints (self vs target user) #}
{% if target_user and target_user.id != request.user.id %}
  {% url 'journal:profile_social_row_user' target_user.id as add_social_url %}
  {% url 'journal:profile_image_row_user'  target_user.id as add_image_url %}
  {% url 'journal:profile_custom_row_user' target_user.id as add_custom_url %}
{% else %}
  {% url 'journal:profile_social_row' as add_social_url %}
  {% url 'journal:profile_image_row'  as add_image_url %}
  {% url 'journal:profile_custom_row' as add_custom_url %}
{% endif %}

<div class="container py-4">
  <h2 class="mb-3">
    {% if target_user and target_user.id != request.user.id %}Edit Profile â€” {{ target_user.get_full_name|default:target_user.username }}
    {% else %}Edit Profile{% endif %}
  </h2>

  <form method="post" enctype="multipart/form-data" class="mt-3">
    {% csrf_token %}

    {# Core profile fields #}
    <div class="card mb-3">
      <div class="card-body">
        {{ form.non_field_errors }}
        {{ form.as_p }}
      </div>
    </div>

    {# Nicknames (array-ish UX) #}
    <h5>Nicknames</h5>
    <div class="card mb-3">
      <div class="card-body">
        {% if profile.nicknames %}<p class="text-muted mb-2">Current: {{ profile.nicknames_list|join:", " }}</p>{% endif %}
        {{ form.new_nickname }}
      </div>
    </div>

    {# Socials #}
    <h5 class="mb-2">Socials</h5>
    <div class="card mb-3">
      <div class="card-body">
        {{ social_fs.management_form }}
        <div id="social-rows">
          {% for f in social_fs %}
            {% include "journal/partials/profile_social_row.html" with form=f only %}
          {% endfor %}
        </div>
        <button type="button"
                class="btn btn-sm btn-outline-secondary"
                hx-get="{{ add_social_url }}?index={{ social_fs.total_form_count }}"
                hx-target="#social-rows"
                hx-swap="beforeend">+ Add Social</button>
      </div>
    </div>

    {# Image Library #}
    <h5 class="mb-2">Image Library</h5>
    <div class="card mb-3">
      <div class="card-body">
        {{ image_fs.management_form }}
        <div id="image-rows">
          {% for f in image_fs %}
            {% include "journal/partials/profile_image_row.html" with form=f only %}
          {% endfor %}
        </div>
        <button type="button"
                class="btn btn-sm btn-outline-secondary"
                hx-get="{{ add_image_url }}?index={{ image_fs.total_form_count }}"
                hx-target="#image-rows"
                hx-swap="beforeend">+ Add Image</button>
      </div>
    </div>

    {# Custom Fields #}
    <h5 class="mb-2">Custom Fields</h5>
    <div class="card mb-3">
      <div class="card-body">
        {{ custom_fs.management_form }}
        <div id="custom-rows">
          {% for f in custom_fs %}
            {% include "journal/partials/profile_custom_row.html" with form=f only %}
          {% endfor %}
        </div>
        <button type="button"
                class="btn btn-sm btn-outline-secondary"
                hx-get="{{ add_custom_url }}?index={{ custom_fs.total_form_count }}"
                hx-target="#custom-rows"
                hx-swap="beforeend">+ Add Custom Field</button>
      </div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-primary">Save</button>
      {% if target_user and target_user.id != request.user.id %}
        <a class="btn btn-secondary" href="{% url 'journal:profile_detail_user' target_user.id %}">Cancel</a>
      {% else %}
        <a class="btn btn-secondary" href="{% url 'journal:profile_detail' %}">Cancel</a>
      {% endif %}
    </div>
  </form>
</div>
{% endblock %}